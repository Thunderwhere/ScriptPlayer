branches:
  only:
    - master

configuration:
  - Debug
  - Release

image: Visual Studio 2017

skip_commits:
  files:
    - README.md

skip_branch_with_pr: true
  
# Taken from https://boblokerse.github.io/2015/11/03/GitVersion-versioning-made-easy-and-dry/
install:
  - ver
  - ps: choco install -y -r --no-progress InnoSetup
  - ps: |
      function gitVersion() {
        $env:newhash = git rev-parse HEAD
        $env:shorthash = git rev-parse --short HEAD
        $env:gitTag = (git describe --tags --abbrev=0 2>$null)

        if (-not [string]::IsNullOrEmpty($env:appveyor_repo_tag_name)) {
          # Tagged build
          $env:newVersion = $env:appveyor_repo_tag_name
          $env:appveyor_info_version = $env:appveyor_repo_tag_name
        }
        elseif (-not [string]::IsNullOrEmpty($env:gitTag)) {
          # Has previous tag, use it with build number
          $env:newVersion = "$env:gitTag.$env:APPVEYOR_BUILD_NUMBER"
          $env:appveyor_info_version = $env:newVersion
        }
        else {
          # No tags found â€” fallback to branch + short hash
          $env:newVersion = "$($env:APPVEYOR_REPO_BRANCH)-$($env:APPVEYOR_BUILD_NUMBER)-$($env:shorthash)"
          $env:appveyor_info_version = $env:newVersion
        }

        $env:appveyor_build_version = $env:newVersion
        appveyor UpdateBuild -Version "$env:newVersion"

        Write-Host "Commit hash: $env:newhash"
        Write-Host "AppVeyor build version: $env:appveyor_build_version"
      }
      gitVersion   
      
# patch the assembly version, but only in our own directories
assembly_info:
  patch: true
  file: '**\AssemblyInfo.*'
  assembly_version: $(appveyor_build_version)
  assembly_file_version: $(appveyor_build_version)
  assembly_informational_version: $(appveyor_info_version)

# Automatically register private account and/or project AppVeyor NuGet feeds.
#nuget:
#  account_feed: true
#  project_feed: true
#  disable_publish_on_pr: true

before_build:
  - nuget restore ScriptPlayer\ScriptPlayer.sln
build:
  parallel: true
  project: ScriptPlayer\ScriptPlayer.sln
  publish_nuget: false
after_build:
  - ps: set PATH=%PATH%;"C:\\Program Files (x86)\\Inno Setup 5"
  - ps: iscc scriptplayer-installer.iss   
  - ps: Push-AppveyorArtifact installer\scriptplayer-installer.exe -FileName ScriptPlayer-$env:CONFIGURATION-$env:APPVEYOR_BUILD_VERSION.exe
